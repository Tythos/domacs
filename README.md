# DOMACS

## The DigitalOcean Minecraft Automated Compute Server

### Background

This is a collection of Terraform resources that can facilitate an automated deployment of a Minecraft server using DigitalOcean.

The server will be exposed with a specific domain you specify in the Terraform variables, along with other inputs.

You can also customize the server properties by modifying the relevant block of the `user_data.yaml.tpl` file but be aware this may cause the VM to reboot; adjusting in-place may be preferable and will persist because these resources include a cloud volume mounted against the Minecraft data path.

### Deployment

Provide values for the Terraform variables by either defining a `terraform.tfvars` file (which will be excluded from version control via `.gitignore`), or by defining environmental variables with the `TF_VAR_` prefix.

Once these variables are defined, deployment is a simple Terraform three-step:

```sh
terraform init
terraform plan
terraform apply
```

Please note that the domain name you use (see the Terraform variable `DOMAIN_NAME`) should be:

1. Registered by you with a known domain registrar

1. Pointing to DigitalOcean nameservers (e.g., `NS` records)

### Verification and Debugging

There are several points during deployment you can inspect to verify and debug the process:

*SSH into VM:*

```sh
terraform output -raw PRIVATE_SSH_KEY > id_rsa
ssh -i id_rsa root@$(terraform output VM_IP_ADDR)
```

*Check cloud-init logs:*

```sh
tail -f /var/log/cloud-init.log
tail -f /var/log/cloud-init-output.log
```

(The second command is probably the most useful one to follow on this whole page when tracking to see if the server has started and what server events have taken place.)

*Verify the Minecraft process is running:*

```sh
screen -ls
ps aux | grep java
```

*Check Minecraft server logs:*

(adjust for mount path if volume changes)

```sh
export PERSISTENT_VOLUME_PATH=/mnt/dovolume/minecraft
tail -f $PERSISTENT_VOLUME_PATH/logs/latest.log
```

*Verify EULA acceptance:*

```sh
cat $PERSISTENT_VOLUME_PATH/eula.txt
```

A basic `server.properites` is written out by the cloud-init configuration; this includes a setting that enables the whitelist, which is initially empty. To add a player to the whitelist, edit the file at `$PERSISTENT_VOLUME_PATH/whitelist.json`; see https://minecraft.wiki/w/Whitelist.json for more details.

### Configuration

Inputs are defined in `terraform.tfvars` (which is gitignore'd) and are documented by the specifications in `variables.tf`.

The `ADMIN_USER` and `ADMIN_UUID` defines a specific "operators" account that can connect before the full whitelist is configured. To add additional users without restarting the VM, you can use the in-game `/whitelist add [username]` command directly or adjust the contents of the `whitelist.json` file (see https://minecraft.fandom.com/wiki/Whitelist.json for details):

1. Look up their UUID (see https://mcuuid.net for details); note that XBox-only (e.g., Minecraft for Windows and / or kids in family account) profiles will *NOT* have a Minecraft name (just a "Gamer Tag") and therefore *CANNOT* be whitelisted

2. SSH into the server using the key generated by the infrastructure (sensitive output `PRIVATE_SSH_KEY`)

3. Edit the whitelist file at `$PERSISTENT_VOLUME_PATH/whitelist.json`, adding a new JSON block for that user

4. From the console, run `/whitelist reload` to update the list of users allowed to connect to the server

### TODO

- [ ] The server is currently Java-only, which may be a problem for users connecting from consoles; the process for switching this should be documented and verified

- [x] The server world is currently only persistent for the lifetime of the VM; the server program itself can be restarted but if the VM is shut down (as Terraforom will do automatically if the configuration changes, including cloud-init content), the world will be lost; persistent could be added by mounting in a defined storage volume

- [ ] Right now the droplet runs under root; we should update the cloud-init configuration to disable root access or at least launch the server under a user profile with restricted privileges

- [ ] Outline and document via new software engineering episode?

- [ ] Extract server properties to its own template file?
